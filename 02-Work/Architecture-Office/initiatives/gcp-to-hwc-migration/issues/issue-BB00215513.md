# Issue Report: BB00215513 - Order Creation Failed

**Status**: üî¥ Open - Under Investigation  
**Severity**: High (User-Facing)  
**Date Reported**: 2025-08-03  
**Team**: UPG (Marketing Integration)

---

## üë§ User Information

| Field | Value |
|-------|-------|
| **Name** | Rully |
| **Bluebird ID** | BB00215513 |
| **Contact** | +62817130074 |
| **Email** | uwie75@gmail.com |

---

## üêõ Issue Description

User unable to complete advance order booking with promotional code. Order creation failed at marketing promo code validation stage.

### Booking Details
- **Booking Type**: Advance Order
- **Service Type**: Blue Bird Taxi (ID: 32)
- **Payment Method**: GoPay
- **Promo Code**: BBMERDEKA
- **Pickup Time**: 08:25 (scheduled for 2025-08-03)
- **Pickup Location**: Lat -6.201824, Long 106.830155
- **Destination**: Lat -6.256787, Long 106.800182
- **Order Attempt Time**: 2025-08-03 06:53 WIB

---

## üîç Investigation

### Timeline Analysis

#### GCP Fleet Visit History (Last 7 Days)
- 2025-07-28 17:27 - (incomplete)
- 2025-08-02 21:45 - (incomplete)

#### HWC Fleet Visit History (Last 7 Days)
- 2025-08-03 06:53 - 06:57 ‚ùå Failed
- 2025-08-03 08:17 - (incomplete)
- 2025-08-03 11:27 - 11:28
- 2025-08-04 06:10 - 06:11
- 2025-08-04 10:14 - (incomplete)

### Key Observation
User attempted to create advance order on **2025-08-03 at 06:53** for pickup at **08:25**, but the order **did not reach the database**.

---

## üí• Error Details

### Marketing Service Error

**Error Type**: Server Error (HTTP 500)  
**Service**: Marketing Promo Validation  
**Timestamp**: 2025-08-03 06:55:32 WIB

#### Full Error Log
```json
{
  "log": "[Error] 2025/08/03 06:55:32.375709496 validate_marketing_promo_code.go:36 [event=validate_marketing_promo_code_error] [request_id=fe3f8365-9258-44c6-bb7c-e533c1920074] [trace_id=8a979b50-0e37-4d4f-9904-1c9f718ee521] [message=server error (500)] [request={\"app_version\":\"6.18.1\",\"identifier\":\"BB00215513\",\"promotion_code\":\"BBMERDEKA\",\"service_type\":\"blue_bird_taxi\",\"payment_type\":\"gopay\",\"epayment_token\":\"62817130074\",\"pickup_lat\":-6.201824430826405,\"pickup_long\":106.83015514165163,\"destination_lat\":-6.256787399999999,\"destination_long\":106.8001817,\"pickup_time\":1754184353,\"service_type_id\":32,\"booking_type\":\"advance\",\"email\":\"uwie75@gmail.com\",\"phone_number\":\"+62817130074\",\"minimum_fare\":0,\"is_to_airport\":false}] [function=ValidateMarketingPromo]\n",
  "stream": "stdout",
  "time": "2025-08-02T23:55:32.37578327Z"
}
```

### Request Parameters
```json
{
  "app_version": "6.18.1",
  "identifier": "BB00215513",
  "promotion_code": "BBMERDEKA",
  "service_type": "blue_bird_taxi",
  "payment_type": "gopay",
  "epayment_token": "62817130074",
  "pickup_lat": -6.201824430826405,
  "pickup_long": 106.83015514165163,
  "destination_lat": -6.256787399999999,
  "destination_long": 106.8001817,
  "pickup_time": 1754184353,
  "service_type_id": 32,
  "booking_type": "advance",
  "email": "uwie75@gmail.com",
  "phone_number": "+62817130074",
  "minimum_fare": 0,
  "is_to_airport": false
}
```

### Trace IDs
- **Request ID**: `fe3f8365-9258-44c6-bb7c-e533c1920074`
- **Trace ID**: `8a979b50-0e37-4d4f-9904-1c9f718ee521`

---

## üî¨ Root Cause Analysis

### Primary Issue
**Marketing Service Unavailable/Timeout**

The marketing promo code validation service returned HTTP 500 error, preventing order creation from proceeding.

### Potential Causes
1. **Service Unavailability**:
   - Marketing service down or unresponsive
   - Timeout during HWC migration
   - Service not properly routed to HWC

2. **Network Issues**:
   - Connectivity between booking service and marketing service
   - DNS resolution problem
   - Firewall/security group misconfiguration

3. **Database Issues**:
   - Marketing database connection timeout
   - Promo code query performance degradation
   - Database lock or deadlock

4. **Migration-Related**:
   - Service not fully migrated to HWC
   - Configuration mismatch between environments
   - Feature flag interference

---

## üíº Business Impact

### User Impact
- **Immediate**: User unable to book ride with promotional code
- **User Experience**: Frustration, potential app abandonment
- **Reputation**: Negative perception during migration period

### Operational Impact
- **Failed Orders**: At least 1 confirmed case (likely more)
- **Lost Revenue**: Potential customer churn
- **Support Burden**: Customer service inquiries

---

## üîß Immediate Actions Taken

1. **Error Logged**: Issue documented with full trace information
2. **User Notified**: Support team contacted user (if applicable)
3. **Monitoring Enhanced**: Additional alerts for marketing service errors

---

## üìã Required Investigation

### UPG Team (Erwin - Owner)
- [ ] Check marketing service health on HWC
- [ ] Verify service routing and DNS configuration
- [ ] Review marketing service logs for 2025-08-03 06:55
- [ ] Test promo code "BBMERDEKA" validation manually
- [ ] Check database connection status
- [ ] Verify error handling and retry logic

### Infrastructure Team
- [ ] Verify network connectivity to marketing service
- [ ] Check security group rules for marketing service
- [ ] Review load balancer health checks
- [ ] Validate DNS resolution for marketing endpoints

### Database Team
- [ ] Check marketing database performance metrics
- [ ] Review slow query logs for validation queries
- [ ] Verify connection pool configuration
- [ ] Check for locks or blocking queries

---

## üéØ Resolution Strategy

### Short-term (Immediate)
1. **Service Health Check**: Ensure marketing service is running and accessible
2. **Manual Order Processing**: Assist user through customer support if needed
3. **Monitoring**: Enhanced alerting for similar errors

### Medium-term
1. **Error Handling Improvement**: Better retry logic and user messaging
2. **Timeout Configuration**: Adjust timeouts for marketing service calls
3. **Circuit Breaker**: Implement circuit breaker pattern for resilience
4. **Fallback Strategy**: Allow order without promo code if service unavailable

### Long-term
1. **Service Resilience**: Make marketing validation non-blocking
2. **Async Validation**: Validate promo code asynchronously
3. **Cache Layer**: Cache valid promo codes to reduce service dependency
4. **SLA Definition**: Establish SLA for marketing service availability

---

## üìä Related Issues

- Similar errors may exist for other users during the same time window
- Check for pattern of marketing service errors on 2025-08-03 morning
- Review if other promotional codes are affected

---

## üìé Evidence

### Screenshots
- User error screen (if available)
- Marketing service error (see log above)

### Database Queries
```sql
-- Check for orders from this user around the time of failure
SELECT * FROM orders 
WHERE user_id = 'BB00215513' 
AND created_at BETWEEN '2025-08-03 06:00:00' AND '2025-08-03 07:00:00';

-- Check marketing service calls
SELECT * FROM marketing_api_logs 
WHERE promo_code = 'BBMERDEKA' 
AND created_at BETWEEN '2025-08-03 06:50:00' AND '2025-08-03 07:00:00';
```

---

## üìù Follow-up Actions

### Immediate (24 hours)
- [ ] Erwin: Investigate marketing service logs
- [ ] Erwin: Test promo code validation
- [ ] Support: Follow up with user Rully

### Short-term (1 week)
- [ ] Implement better error handling
- [ ] Add retry logic
- [ ] Improve user-facing error messages
- [ ] Create runbook for marketing service issues

### Long-term (1 month)
- [ ] Implement circuit breaker pattern
- [ ] Add promo code caching
- [ ] Consider async validation approach
- [ ] Add comprehensive monitoring

---

## üè∑Ô∏è Tags

#bug #user-impact #marketing #promo-code #upg #migration-related #high-priority

---

## üìû Contact

**Primary Owner**: Erwin (UPG Team)  
**Support**: Customer Service  
**Escalation**: Lukmanul Hakim (Architecture Lead)

---

*Last Updated: 2025-08-04*  
*Status: Under Investigation*  
*Next Review: 2025-08-05*
